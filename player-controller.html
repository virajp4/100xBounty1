<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.11.7/video-js.min.css"
      rel="stylesheet"
    />
    <title>VideoJS Custom Player</title>
    <link rel="stylesheet" href="player-style.css" />
  </head>
  <body>
    <div style="margin: 50px auto">
      <video id="my-video" class="video-js"></video>
    </div>
    <div id="buttons"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.11.7/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-eme@3.8.0/dist/videojs-contrib-eme.js"></script>

    <script>
      const segments = [
        { start: 0, end: 30, title: "Introduction" },
        { start: 31, end: 100, title: "Learning HTML" },
        { start: 101, end: 180, title: "Learning CSS" },
        { start: 181, title: "Learning JS" },
      ];

      var player = videojs("my-video", {
        controls: true,
        fluid: true,
        html5: {
          vhs: { overrideNative: true },
        },
      });

      player.eme();
      player.src({
        src: "https://cdn.bitmovin.com/content/assets/art-of-motion_drm/mpds/11331.mpd",
        type: "application/dash+xml",
        keySystems: {
          "com.widevine.alpha": "https://cwip-shaka-proxy.appspot.com/no_auth",
        },
      });

      function updateSegmentTitle(currentTime) {
        const currentSegment = segments.find(
          (segment) => currentTime >= segment.start && currentTime <= segment.end
        );
      }

      function makeSegmentButton(segment) {
        const SegmentButtons = document.getElementById("buttons");
        const segmentButton = document.createElement("button");
        segmentButton.classList.add("segment-button");
        segmentButton.textContent = segment.title;
        segmentButton.onclick = function () {
          scrollToSegment(segment.start);
        };
        document.body.appendChild(segmentButton);
        return segmentButton;
      }

      function makeControlBar(segment, startPosition, endPosition) {
        const marker = document.createElement("div");
        marker.classList.add("vjs-chapter-marker");
        if (segment.end) {
          marker.style.left = `${endPosition}%`;
        }

        const overlay = document.createElement("div");
        overlay.classList.add("vjs-chapter-overlay");
        overlay.style.left = `${startPosition}%`;
        overlay.style.width = `${endPosition - startPosition}%`;

        const label = document.createElement("div");
        label.classList.add("vjs-chapter-label");
        label.textContent = segment.title;
        overlay.appendChild(label);

        const controlBar = player.el().querySelector(".vjs-progress-control");
        controlBar.appendChild(marker);
        controlBar.appendChild(overlay);

        overlay.addEventListener("mousemove", function (event) {
          const offsetX = event.offsetX;
          const labelWidth = label.clientWidth;
          const maxX = overlay.clientWidth - labelWidth;
          const labelPosition = offsetX - labelWidth / 2;
          label.style.left = `${labelPosition}px`;
        });

        return controlBar;
      }

      function scrollToSegment(startTime) {
        player.currentTime(startTime);
        player.play();
      }

      player.on("error", function () {
        console.error("Video Player Error: ", player.error());
      });

      player.on("timeupdate", function () {
        const currentTime = player.currentTime();
        updateSegmentTitle(currentTime);
      });

      player.ready(function () {
        player.on("loadedmetadata", function () {
          const duration = player.duration();
          segments.forEach((segment) => {
            const segmentButton = makeSegmentButton(segment);

            const startPosition = (segment.start / duration) * 100;
            let endPosition;
            if (segment.end) {
              endPosition = (segment.end / duration) * 100;
            } else {
              endPosition = 100;
            }

            const controlBar = makeControlBar(segment, startPosition, endPosition);
          });

          player.on("play", function () {
            hideTooltips();
          });

          player.on("pause", function () {
            const currentTime = player.currentTime();
            showCurrentTooltips(currentTime);
          });

          function showCurrentTooltips(currentTime) {
            hideTooltips();
            const currentSegment = segments.find(
              (segment) => currentTime >= segment.start && currentTime <= segment.end
            );
            if (currentSegment) {
              const tooltips = document.querySelectorAll(".vjs-chapter-label");
              tooltips.forEach((tooltip) => {
                if (tooltip.textContent === currentSegment.title) {
                  tooltip.classList.remove("hide");
                }
              });
            }
          }

          function hideTooltips() {
            const tooltips = document.querySelectorAll(".vjs-chapter-label");
            tooltips.forEach((tooltip) => {
              tooltip.classList.add("hide");
            });
          }
        });
      });
    </script>
  </body>
</html>
